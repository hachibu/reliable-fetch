"use strict";var v=Object.create;var s=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var I=(o,e)=>{for(var t in e)s(o,t,{get:e[t],enumerable:!0})},d=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of k(e))!H.call(o,i)&&i!==t&&s(o,i,{get:()=>e[i],enumerable:!(r=T(e,i))||r.enumerable});return o};var b=(o,e,t)=>(t=o!=null?v(q(o)):{},d(e||!o||!o.__esModule?s(t,"default",{value:o,enumerable:!0}):t,o)),N=o=>d(s({},"__esModule",{value:!0}),o);var M={};I(M,{ReliableFetch:()=>p,ReliableFetchChaosError:()=>n,default:()=>L,fetchChaos:()=>l,fetchHedge:()=>u,fetchRetry:()=>h,fetchTimeout:()=>m});module.exports=N(M);var n=class extends Error{};var R=b(require("crypto")),g=()=>R.default.randomInt(0,100)/100,f=(o,e)=>g()*(e-o)+o,C=(o,e)=>{let t=setTimeout(o,e);return{id:t,cancel:()=>clearTimeout(t)}};var P=async(o,e)=>{let t={rate:1-(e?.rate??0)},r=g();if(t.rate<0||t.rate>1)throw new RangeError("rate: should be between 0 and 1");if(r>t.rate)throw e?.eventEmitter?.emit("chaos"),new n(`${r.toFixed(2)} > ${t.rate} `);return fetch(o,e)},l=P;var A=async(o,e)=>{let t={timeout:e?.timeout??1e4},r=new AbortController,{cancel:i}=C(()=>{r.abort(),e?.eventEmitter?.emit("timeout")},t.timeout);return fetch(o,{...e,signal:r.signal}).finally(i)},m=A;var B=async(o,e)=>{let t={timeout:e?.timeout??1e4},r;try{r=await m(o,{...e,...t})}catch(i){if(i instanceof Error&&i.name!=="AbortError")throw i;e?.eventEmitter?.emit("hedge"),r=await fetch(o,e)}return r},u=B;var y=require("timers/promises");var j=async(o,e)=>{let t={delay:e?.delay??100,maxDelay:e?.maxDelay??1e4,attempts:e?.attempts??1,maxAttempts:e?.maxAttempts??10,backoff:e?.backoff??"constant",jitter:e?.jitter??"none"},r=[],i=[],F=Math.min(t.attempts,t.maxAttempts);try{return await fetch(o,e)}catch(a){r.push(a)}for(let a=0;a<F;a++){let w=a+1,c=Math.min(t.delay,t.maxDelay);i.push(c),e?.eventEmitter?.emit("retry",a+1,c);try{return await fetch(o,e)}catch(E){r.push(E)}switch(await(0,y.setTimeout)(c),t.backoff){case"exponential":t.delay=Math.pow(2,w)*c;break;case"fibonacci":i.length>1&&(t.delay=i[i.length-2]+i[i.length-1]);break}switch(t.jitter){case"naive":t.delay+=f(0,c*.2);break;case"equal":t.delay=t.delay/2+f(0,t.delay/2);break;case"full":t.delay=f(0,t.delay);break}}throw r.at(-1)},h=j;var x=b(require("events")),p=class{constructor(e,t={}){this.input=e;this.init=t;this.init.eventEmitter=new x.default}on(e,t){let{eventEmitter:r}=this.init;return r&&r.on(e,t),this}timeout(e){return m(this.input,{...this.init,...e})}hedge(e){return u(this.input,{...this.init,...e})}chaos(e){return l(this.input,{...this.init,...e})}retry(e){return h(this.input,{...this.init,...e})}},D=(o,e)=>new p(o,e),L=D;0&&(module.exports={ReliableFetch,ReliableFetchChaosError,fetchChaos,fetchHedge,fetchRetry,fetchTimeout});
//# sourceMappingURL=index.js.map
