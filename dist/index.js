"use strict";var x=Object.create;var c=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var k=(o,e)=>{for(var t in e)c(o,t,{get:e[t],enumerable:!0})},g=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of E(e))!v.call(o,i)&&i!==t&&c(o,i,{get:()=>e[i],enumerable:!(r=w(e,i))||r.enumerable});return o};var q=(o,e,t)=>(t=o!=null?x(T(o)):{},g(e||!o||!o.__esModule?c(t,"default",{value:o,enumerable:!0}):t,o)),H=o=>g(c({},"__esModule",{value:!0}),o);var j={};k(j,{ReliableFetch:()=>p,ReliableFetchChaosError:()=>n,default:()=>M,fetchChaos:()=>f,fetchHedge:()=>u,fetchRetry:()=>h,fetchTimeout:()=>m});module.exports=H(j);var n=class extends Error{};var I=async(o,e)=>{let t={rate:1-(e?.rate??0)},r=Math.random();if(t.rate<0||t.rate>1)throw new RangeError("rate: should be between 0 and 1");if(r>t.rate)throw e?.eventEmitter?.emit("chaos"),new n(`${r.toFixed(2)} > ${t.rate} `);return fetch(o,e)},f=I;var l=(o,e)=>Math.random()*(e-o)+o,d=(o,e)=>{let t=setTimeout(o,e);return{id:t,cancel:()=>clearTimeout(t)}};var P=async(o,e)=>{let t={timeout:e?.timeout??1e4},r=new AbortController,{cancel:i}=d(()=>{r.abort(),e?.eventEmitter?.emit("timeout")},t.timeout);return fetch(o,{...e,signal:r.signal}).finally(i)},m=P;var N=async(o,e)=>{let t={timeout:e?.timeout??0},r;try{r=await m(o,{...e,...t})}catch(i){if(i instanceof Error&&i.name!=="AbortError")throw i;e?.eventEmitter?.emit("hedge"),r=await fetch(o,e)}return r},u=N;var R=require("timers/promises");var A=async(o,e)=>{let t={delay:e?.delay??100,maxDelay:e?.maxDelay??1e4,attempts:e?.attempts??1,maxAttempts:e?.maxAttempts??10,backoff:e?.backoff??"constant",jitter:e?.jitter??"none"},r=[],i=[],C=Math.min(t.attempts,t.maxAttempts);try{return await fetch(o,e)}catch(a){r.push(a)}for(let a=0;a<C;a++){let y=a+1,s=Math.min(t.delay,t.maxDelay);i.push(s),e?.eventEmitter?.emit("retry",a+1,s);try{return await fetch(o,e)}catch(F){r.push(F)}switch(await(0,R.setTimeout)(s),t.backoff){case"exponential":t.delay=Math.pow(2,y)*s;break;case"fibonacci":i.length>1&&(t.delay=i[i.length-2]+i[i.length-1]);break}switch(t.jitter){case"naive":t.delay+=l(0,s*.2);break;case"equal":t.delay=t.delay/2+l(0,t.delay/2);break;case"full":t.delay=l(0,t.delay);break}}throw r.at(-1)},h=A;var b=q(require("events")),p=class{constructor(e,t={}){this.input=e;this.init=t;this.init.eventEmitter=new b.default}on(e,t){let{eventEmitter:r}=this.init;if(r){if(r.listenerCount(e)>0)return this;r.on(e,t)}else return this;return this}timeout(e){return m(this.input,{...this.init,...e})}hedge(e){return u(this.input,{...this.init,...e})}chaos(e){return f(this.input,{...this.init,...e})}retry(e){return h(this.input,{...this.init,...e})}},B=(o,e)=>new p(o,e),M=B;0&&(module.exports={ReliableFetch,ReliableFetchChaosError,fetchChaos,fetchHedge,fetchRetry,fetchTimeout});
//# sourceMappingURL=index.js.map
